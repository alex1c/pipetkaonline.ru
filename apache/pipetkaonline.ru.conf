<VirtualHost *:80>
    ServerName pipetkaonline.ru
    ServerAlias www.pipetkaonline.ru

    # Redirect HTTP to HTTPS
    Redirect permanent / https://pipetkaonline.ru/
</VirtualHost>

<VirtualHost *:443>
    ServerName pipetkaonline.ru
    ServerAlias www.pipetkaonline.ru

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/pipetkaonline.ru/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/pipetkaonline.ru/privkey.pem

    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Proxy to Docker container
    ProxyPreserveHost On
    ProxyPass / http://localhost:3002/
    ProxyPassReverse / http://localhost:3002/

    # WebSocket support (if needed)
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*) ws://localhost:3002/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*) http://localhost:3002/$1 [P,L]

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/pipetkaonline.ru_error.log
    CustomLog ${APACHE_LOG_DIR}/pipetkaonline.ru_access.log combined
</VirtualHost>

